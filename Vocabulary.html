<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—è¤‡ç¿’æ©Ÿ</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«”ç‚º Inter (æˆ–ä»»ä½•ç„¡è¥¯ç·šå­—é«”) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“ textarea æ›´ç¾è§€ */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="w-full max-w-lg bg-white shadow-xl rounded-2xl p-6 md:p-8 space-y-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">è‹±æ–‡å–®å­—è¤‡ç¿’æ©Ÿ ğŸ§ </h1>
        <p id="user-info" class="text-sm text-gray-500 text-center break-all">ä½¿ç”¨è€… ID: è¼‰å…¥ä¸­...</p>
        
        <!-- ç‹€æ…‹è¨Šæ¯èˆ‡è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="status-message" class="text-center text-sm font-medium p-2 rounded-lg transition-opacity duration-300 opacity-0 h-8"></div>
        <div id="loading-indicator" class="text-center text-blue-500 font-medium hidden">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            è³‡æ–™è¼‰å…¥ä¸­...
        </div>

        <!-- å–®å­—åº«è¨­å®šå€å¡Š -->
        <div id="config-view" class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">å–®å­—åº«è¨­å®š</h2>
            
            <textarea id="vocab-editor" rows="10" 
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm shadow-sm"
                      placeholder="è«‹è¼¸å…¥å–®å­—åˆ—è¡¨ï¼Œæ¯è¡Œä¸€å€‹å–®å­—èˆ‡ä¸­æ–‡ï¼Œä¸­é–“ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼š&#10;apple, è˜‹æœ&#10;banana, é¦™è•‰&#10;cat, è²“"></textarea>

            <div class="flex flex-col space-y-2">
                <button onclick="saveVocab()" 
                        class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01]">
                    å„²å­˜å–®å­—åº«ä¸¦é–‹å§‹è¤‡ç¿’
                </button>
                <button onclick="showQuizView()" id="start-quiz-button"
                        class="w-full bg-emerald-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-emerald-600 transition duration-150 ease-in-out shadow-md" style="display: none;">
                    ç¹¼çºŒè¤‡ç¿’ (å·²æœ‰å–®å­—)
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mt-2 text-center">
                æ ¼å¼è¦æ±‚ï¼šè‹±æ–‡, ä¸­æ–‡ (ä¸­é–“è«‹ç”¨åŠå½¢é€—è™Ÿåˆ†éš”ï¼Œä¸€è¡Œä¸€çµ„)
            </p>
        </div>

        <!-- è¤‡ç¿’å€å¡Š (éš±è—) -->
        <div id="quiz-view" class="space-y-6 hidden pt-4">
            <h2 class="text-xl font-semibold text-gray-700 text-center">é–‹å§‹è¤‡ç¿’ï¼ğŸ’ª</h2>

            <div class="bg-blue-50 p-6 rounded-xl text-center shadow-inner">
                <p class="text-base text-gray-600 mb-2">è«‹è¼¸å…¥ä¸‹åˆ—ä¸­æ–‡å°æ‡‰çš„è‹±æ–‡ï¼š</p>
                <!-- é¡¯ç¤ºä¸­æ–‡ä¸¦å¯é»æ“Šç™¼éŸ³ -->
                <button id="current-chinese" onclick="speakEnglishWord()"
                        class="text-4xl font-extrabold text-blue-700 bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-blue-100 transition transform hover:scale-105 active:scale-95 duration-200 w-full md:w-auto mx-auto border-4 border-blue-200">
                    é»æˆ‘é–‹å§‹
                </button>
            </div>
            
            <!-- ä½¿ç”¨è€…è¼¸å…¥å€ -->
            <div class="space-y-4">
                <input type="text" id="english-input" placeholder="åœ¨é€™è£¡è¼¸å…¥è‹±æ–‡å–®å­—..."
                       class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:ring-purple-500 focus:border-purple-500 shadow-md transition"
                       onkeydown="if (event.key === 'Enter') checkAnswer()">
                
                <button onclick="checkAnswer()"
                        class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-purple-700 transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01]">
                    æª¢æŸ¥ç­”æ¡ˆ
                </button>
            </div>

            <!-- ç­”æ¡ˆå›é¥‹å€ -->
            <div id="feedback-area" class="min-h-12 p-3 rounded-xl font-medium text-center transition-all duration-500 hidden"></div>
            
            <!-- å°èˆªæŒ‰éˆ• -->
            <div class="flex justify-between space-x-3 pt-4 border-t border-gray-200">
                <button onclick="nextWord(true)" id="skip-button"
                        class="flex-1 bg-yellow-500 text-white font-semibold py-2 rounded-xl hover:bg-yellow-600 transition shadow-md">
                    è·³é/é¡¯ç¤ºä¸‹ä¸€é¡Œ
                </button>
                <button onclick="showConfigView()"
                        class="flex-1 bg-gray-400 text-white font-semibold py-2 rounded-xl hover:bg-gray-500 transition shadow-md">
                    è¿”å›è¨­å®š
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK è¼‰å…¥ -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®šå…¨åŸŸè®Šæ•¸ (Global variables setup)
        window.vocabList = [];
        window.currentWordIndex = 0;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'vocab-review-app';

        // é è¨­å–®å­— (Default vocabulary for first-time users)
        const defaultVocab = [
            { english: "apple", chinese: "è˜‹æœ" },
            { english: "banana", chinese: "é¦™è•‰" },
            { english: "cat", chinese: "è²“" },
            { english: "dog", chinese: "ç‹—" },
            { english: "house", chinese: "æˆ¿å­" },
            { english: "water", chinese: "æ°´" },
            { english: "computer", chinese: "é›»è…¦" },
            { english: "book", chinese: "æ›¸æœ¬" },
            { english: "friend", chinese: "æœ‹å‹" },
            { english: "happy", chinese: "å¿«æ¨‚" },
        ];

        // UI å…ƒç´  (UI Elements)
        const elements = {
            loadingIndicator: document.getElementById('loading-indicator'),
            statusMessage: document.getElementById('status-message'),
            vocabEditor: document.getElementById('vocab-editor'),
            configView: document.getElementById('config-view'),
            quizView: document.getElementById('quiz-view'),
            currentChinese: document.getElementById('current-chinese'),
            englishInput: document.getElementById('english-input'),
            feedbackArea: document.getElementById('feedback-area'),
            userInfo: document.getElementById('user-info'),
            startQuizButton: document.getElementById('start-quiz-button'),
        };

        // --- è¼”åŠ©å‡½å¼ (Utility Functions) ---

        /** é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ */
        function showStatus(message, isError = false) {
            elements.statusMessage.textContent = message;
            elements.statusMessage.className = `text-center text-sm font-medium p-2 rounded-lg transition-opacity duration-300 opacity-100 h-8 ${
                isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'
            }`;
            setTimeout(() => {
                elements.statusMessage.classList.remove('opacity-100');
                elements.statusMessage.classList.add('opacity-0');
            }, 3000);
        }

        /** æ´—ç‰Œæ¼”ç®—æ³• (Fisher-Yates) */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /** å°‡å–®å­—åˆ—è¡¨è½‰æ›ç‚ºç·¨è¼¯å™¨æ–‡å­—æ ¼å¼ */
        function vocabToText(vocab) {
            return vocab.map(w => `${w.english}, ${w.chinese}`).join('\n');
        }

        /** å°‡ç·¨è¼¯å™¨æ–‡å­—æ ¼å¼è½‰æ›ç‚ºå–®å­—åˆ—è¡¨ */
        function textToVocab(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    return {
                        english: parts[0].trim().toLowerCase(),
                        chinese: parts.slice(1).join(',').trim()
                    };
                }
                return null;
            }).filter(w => w !== null && w.english && w.chinese);
        }

        // --- Firebase ç›¸é—œ (Firebase Setup and Data Handling) ---

        /** åˆå§‹åŒ– Firebase */
        async function initializeFirebase() {
            setLogLevel('debug');
            elements.loadingIndicator.classList.remove('hidden');

            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                // å˜—è©¦ä½¿ç”¨è‡ªå®šç¾© token ç™»å…¥ï¼Œå¦å‰‡åŒ¿åç™»å…¥
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        elements.userInfo.textContent = `ä½¿ç”¨è€… ID: ${window.userId}`;
                        setupVocabListener();
                    } else {
                        // å¦‚æœæ²’æœ‰ç™»å…¥ï¼Œè¨­ç½®ä¸€å€‹éš¨æ©Ÿ ID
                        window.userId = crypto.randomUUID();
                        elements.userInfo.textContent = `ä½¿ç”¨è€… ID: ${window.userId} (åŒ¿å)`;
                        // å³ä½¿åŒ¿åï¼Œä¹Ÿè¦å˜—è©¦è¼‰å…¥æˆ–ä½¿ç”¨é è¨­å–®å­—
                        loadInitialVocab();
                    }
                    elements.loadingIndicator.classList.add('hidden');
                });
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showStatus("Firebase é€£ç·šå¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­å–®å­—ã€‚è©³æƒ…è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚", true);
                loadInitialVocab(); // å³ä½¿å¤±æ•—ä¹Ÿä½¿ç”¨é è¨­å–®å­—
                elements.loadingIndicator.classList.add('hidden');
            }
        }

        /** è¼‰å…¥å–®å­—åº«ç›£è½å™¨ */
        function setupVocabListener() {
            if (!window.db || !window.userId) return;

            const vocabDocRef = doc(window.db, 
                `artifacts/${window.appId}/users/${window.userId}/vocabulary`, 
                "vocab_data"
            );

            onSnapshot(vocabDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().list) {
                    window.vocabList = docSnap.data().list;
                    elements.vocabEditor.value = vocabToText(window.vocabList);
                    showStatus(`å–®å­—åº« (${window.vocabList.length} ç­†) å·²å¾é›²ç«¯è¼‰å…¥ã€‚`);
                    
                    if (window.vocabList.length > 0) {
                        elements.startQuizButton.style.display = 'block';
                    }
                } else {
                    console.log("Firestore ä¸­ç„¡å–®å­—è³‡æ–™ï¼Œè¼‰å…¥é è¨­å–®å­—ã€‚");
                    loadInitialVocab();
                }
            }, (error) => {
                console.error("ç›£è½å–®å­—åº«å¤±æ•—:", error);
                showStatus("å–®å­—åº«è³‡æ–™åŒæ­¥å¤±æ•—ã€‚è©³æƒ…è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚", true);
                loadInitialVocab();
            });
        }

        /** è¼‰å…¥æˆ–è¨­ç½®é è¨­å–®å­— */
        function loadInitialVocab() {
            if (window.vocabList.length === 0) {
                window.vocabList = defaultVocab;
                elements.vocabEditor.value = vocabToText(defaultVocab);
                showStatus(`å·²è¼‰å…¥ ${defaultVocab.length} ç­†é è¨­å–®å­—ã€‚è«‹é»æ“Šã€Œå„²å­˜ã€ä»¥ä¿å­˜è‡³æ‚¨çš„å¸³æˆ¶ã€‚`);
            }
            if (window.vocabList.length > 0) {
                elements.startQuizButton.style.display = 'block';
            }
        }

        /** å„²å­˜å–®å­—åº«åˆ° Firestore */
        window.saveVocab = async function() {
            elements.loadingIndicator.classList.remove('hidden');
            const newVocab = textToVocab(elements.vocabEditor.value);

            if (newVocab.length === 0) {
                showStatus("å–®å­—åº«ä¸èƒ½ç‚ºç©ºï¼", true);
                elements.loadingIndicator.classList.add('hidden');
                return;
            }

            window.vocabList = newVocab;
            
            if (window.db && window.userId) {
                const vocabDocRef = doc(window.db, 
                    `artifacts/${window.appId}/users/${window.userId}/vocabulary`, 
                    "vocab_data"
                );
                
                try {
                    await setDoc(vocabDocRef, { list: window.vocabList });
                    showStatus(`å–®å­—åº« (${window.vocabList.length} ç­†) å„²å­˜æˆåŠŸï¼`);
                } catch (error) {
                    console.error("å„²å­˜å–®å­—åº«å¤±æ•—:", error);
                    showStatus("å–®å­—åº«å„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚", true);
                }
            } else {
                 showStatus(`å–®å­—åº« (${window.vocabList.length} ç­†) å·²åœ¨æœ¬åœ°æ›´æ–°ã€‚`, true);
            }

            elements.loadingIndicator.classList.add('hidden');
            showQuizView();
        }

        // --- æ‡‰ç”¨ç¨‹å¼æµç¨‹èˆ‡ UI é¡¯ç¤º ---

        /** é¡¯ç¤ºè¨­å®šç•«é¢ */
        window.showConfigView = function() {
            elements.quizView.classList.add('hidden');
            elements.configView.classList.remove('hidden');
            elements.feedbackArea.classList.add('hidden');
            elements.englishInput.value = '';
        }

        /** é¡¯ç¤ºè¤‡ç¿’ç•«é¢ä¸¦é–‹å§‹æ¸¬é©— */
        window.showQuizView = function() {
            if (window.vocabList.length === 0) {
                showStatus("è«‹å…ˆåœ¨è¨­å®šå€è¼¸å…¥å–®å­—ï¼", true);
                return;
            }

            // æ´—ç‰Œä¸¦é–‹å§‹
            window.vocabList = shuffleArray(window.vocabList);
            window.currentWordIndex = 0;
            
            elements.configView.classList.add('hidden');
            elements.quizView.classList.remove('hidden');
            elements.feedbackArea.classList.add('hidden');

            displayNewWord();
            showStatus(`é–‹å§‹è¤‡ç¿’ï¼å…± ${window.vocabList.length} ç­†å–®å­—ã€‚`);
        }

        /** é¡¯ç¤ºä¸‹ä¸€å€‹å–®å­— */
        function displayNewWord() {
            elements.englishInput.value = '';
            elements.feedbackArea.classList.add('hidden');

            if (window.currentWordIndex >= window.vocabList.length) {
                elements.currentChinese.textContent = "ğŸ¥³ å®Œæˆï¼é»æ“Šè¿”å›è¨­å®šã€‚";
                elements.currentChinese.onclick = window.showConfigView;
                elements.englishInput.setAttribute('disabled', 'true');
                document.getElementById('skip-button').setAttribute('disabled', 'true');
                document.querySelector('#quiz-view button:nth-child(2)').setAttribute('disabled', 'true'); // æª¢æŸ¥ç­”æ¡ˆæŒ‰éˆ•
                showStatus("æ­å–œï¼æ‰€æœ‰å–®å­—éƒ½è¤‡ç¿’å®Œç•¢äº†ï¼");
                return;
            }

            const currentWord = window.vocabList[window.currentWordIndex];
            elements.currentChinese.textContent = currentWord.chinese;
            elements.currentChinese.onclick = window.speakEnglishWord;
            elements.englishInput.removeAttribute('disabled');
            document.getElementById('skip-button').removeAttribute('disabled');
            document.querySelector('#quiz-view button:nth-child(2)').removeAttribute('disabled'); // æª¢æŸ¥ç­”æ¡ˆæŒ‰éˆ•
            elements.englishInput.focus();
        }

        /** åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å–®å­— */
        window.nextWord = function(wasSkipped = false) {
            if (wasSkipped) {
                const skippedWord = window.vocabList[window.currentWordIndex];
                showStatus(`å·²è·³éï¼š${skippedWord.english} (${skippedWord.chinese})`);
            }
            window.currentWordIndex++;
            displayNewWord();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå–®å­—æª¢æŸ¥èˆ‡ç™¼éŸ³ ---

        /** æª¢æŸ¥ä½¿ç”¨è€…è¼¸å…¥çš„ç­”æ¡ˆ */
        window.checkAnswer = function() {
            if (window.vocabList.length === 0 || window.currentWordIndex >= window.vocabList.length) return;

            const currentWord = window.vocabList[window.currentWordIndex];
            const userAnswer = elements.englishInput.value.trim().toLowerCase();
            const correctEnglish = currentWord.english.toLowerCase();

            elements.feedbackArea.classList.remove('hidden');
            
            if (userAnswer === correctEnglish) {
                // ç­”å°
                elements.feedbackArea.innerHTML = `<span class="text-green-600 font-bold">âœ… æ­£ç¢ºï¼</span><br>å¤ªæ£’äº†ï¼Œä½ æ‹¼å°äº†ï¼`;
                elements.feedbackArea.classList.replace('bg-red-100', 'bg-green-100');
                elements.feedbackArea.classList.replace('text-red-700', 'text-green-700');
                
                // å»¶é²å¾Œè‡ªå‹•è·³åˆ°ä¸‹ä¸€é¡Œ
                setTimeout(() => window.nextWord(), 1000); 

            } else {
                // ç­”éŒ¯
                elements.feedbackArea.innerHTML = 
                    `<span class="text-red-600 font-bold">âŒ éŒ¯èª¤ï¼</span><br>` + 
                    `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<span class="font-mono">${currentWord.english}</span><br>` +
                    `è«‹å†è©¦ä¸€æ¬¡ï¼Œæˆ–é»æ“Šã€Œè·³é/é¡¯ç¤ºä¸‹ä¸€é¡Œã€ã€‚`;
                elements.feedbackArea.classList.replace('bg-green-100', 'bg-red-100');
                elements.feedbackArea.classList.replace('text-green-700', 'text-red-700');
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œè®“ä½¿ç”¨è€…é‡æ–°å˜—è©¦
                elements.englishInput.value = '';
                elements.englishInput.focus();
            }
        }

        /** å”¸å‡ºè‹±æ–‡å–®å­— (ä½¿ç”¨ Web Speech API) */
        window.speakEnglishWord = function() {
            if (!window.speechSynthesis) {
                showStatus("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³åŠŸèƒ½ã€‚", true);
                return;
            }

            if (window.vocabList.length === 0 || window.currentWordIndex >= window.vocabList.length) return;
            
            const textToSpeak = window.vocabList[window.currentWordIndex].english;
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US'; // è¨­å®šèªè¨€ç‚ºç¾å¼è‹±æ–‡
            utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€é»
            utterance.pitch = 1.0; 

            // ç¢ºä¿èªéŸ³æ²’æœ‰åœ¨æ’­æ”¾ä¸­æ‰é–‹å§‹æ–°çš„æ’­æ”¾
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            speechSynthesis.speak(utterance);
        }

        // --- å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
